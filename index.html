<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kimi K2 - Chat IA (Fix envÃ­o)</title>
  <style>
    :root { --bg:#0d1117; --surface:#161b22; --primary:#58a6ff; --text:#e6edf3; --muted:#8b949e; }
    * { box-sizing: border-box; }
    body { margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); display:flex; flex-direction:column; height:100vh; }
    header { padding:1rem; background:var(--surface); display:flex; align-items:center; justify-content:space-between; }
    #chat-box { flex:1; overflow-y:auto; padding:1rem; display:flex; flex-direction:column; gap:0.75rem; }
    .msg { max-width:70%; padding:0.75rem 1rem; border-radius:1rem; white-space:pre-wrap; }
    .user { align-self:flex-end; background:var(--primary); color:#000; }
    .bot { align-self:flex-start; background:var(--surface); }
    #input-area { display:flex; padding:1rem; background:var(--surface); gap:0.5rem; position:sticky; bottom:0; }
    #user-input { flex:1; padding:0.75rem 1rem; border:none; border-radius:2rem; background:var(--bg); color:var(--text); outline:none; }
    #send-btn { border:none; border-radius:50%; width:3rem; height:3rem; background:var(--primary); color:#000; cursor:pointer; }
    #send-btn[disabled] { opacity:0.6; cursor:not-allowed; }
  </style>
</head>
<body>
  <header>
    <h1>ðŸŒ™ Kimi K2 Chat</h1>
  </header>

  <main id="chat-box" aria-live="polite" aria-label="Mensajes del chat"></main>

  <footer id="input-area">
    <input id="user-input" type="text" placeholder="Escribe tu mensaje..." autocomplete="off" aria-label="Entrada de texto"/>
    <button id="send-btn" type="button" title="Enviar" aria-label="Enviar">âž¤</button>
  </footer>

  <!-- LibrerÃ­a puter -->
  <script src="https://js.puter.com/v2/"></script>

  <!-- Tu lÃ³gica. Importante: SIN atributos inline y cargado al final -->
  <script>
    // Referencias
    const chatBox = document.getElementById('chat-box');
    const input = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');

    let thinking = false;

    // Asegura que el botÃ³n y Enter funcionen
    function bindEvents() {
      sendBtn.addEventListener('click', () => {
        sendMessage();
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    function appendMessage(role, text) {
      const div = document.createElement('div');
      div.className = 'msg ' + role;
      div.textContent = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function normalizeResponse(res) {
      if (res == null) return '';
      if (typeof res === 'string') return res;
      if (typeof res === 'object') {
        if (res.output) return res.output;
        if (res.message) return res.message;
        if (res.text) return res.text;
        if (Array.isArray(res.choices) && res.choices[0]?.message?.content) {
          return res.choices[0].message.content;
        }
        if (res.content) return res.content;
        return JSON.stringify(res);
      }
      return String(res);
    }

    async function ensurePuterReady() {
      const start = Date.now();
      while (!(window.puter && window.puter.ai && typeof window.puter.ai.chat === 'function')) {
        if (Date.now() - start > 5000) throw new Error('Puter no disponible');
        await new Promise(r => setTimeout(r, 100));
      }
    }

    async function sendMessage() {
      const text = input.value.trim();
      if (!text || thinking) return;

      // Estado UI
      thinking = true;
      sendBtn.disabled = true;

      appendMessage('user', text);
      input.value = '';

      const placeholder = document.createElement('div');
      placeholder.className = 'msg bot';
      placeholder.textContent = 'Pensandoâ€¦';
      chatBox.appendChild(placeholder);
      chatBox.scrollTop = chatBox.scrollHeight;

      try {
        await ensurePuterReady();
        const res = await puter.ai.chat(text, { model: 'moonshotai/kimi-k2' });
        const out = normalizeResponse(res);
        placeholder.remove();
        appendMessage('bot', out || 'Respuesta vacÃ­a.');
      } catch (err) {
        console.error(err);
        placeholder.remove();
        appendMessage('bot', 'Error al conectar con Kimi.');
      } finally {
        thinking = false;
        sendBtn.disabled = false;
        input.focus();
      }
    }

    // InicializaciÃ³n segura
    window.addEventListener('DOMContentLoaded', () => {
      bindEvents();
    });
  </script>
</body>
</html>
