<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Chat Kimi K2 Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
* { box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: #f0f2f5; }
.toolbar { background: #fff; padding: 12px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; border-bottom: 2px solid #e0e0e0; }
.toolbar label { display: flex; align-items: center; gap: 5px; font-size: 0.9em; }
#chat-box { height: 60vh; overflow-y: auto; padding: 15px; background: #fff; margin: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.msg { margin: 10px 0; display: flex; gap: 10px; }
.user { justify-content: flex-end; }
.bot { justify-content: flex-start; }
.bubble { padding: 10px 15px; border-radius: 15px; max-width: 75%; }
.user .bubble { background: #0057e7; color: #fff; }
.bot .bubble { background: #e5e7eb; color: #1f2937; }
.file-info { font-size: 0.8em; color: #666; margin: 5px 0; }
#input-area { display: flex; padding: 10px; gap: 10px; }
#user-input { flex: 1; padding: 12px; font-size: 1em; border: 1px solid #ccc; border-radius: 20px; }
button { padding: 10px 20px; font-size: 1em; border: none; border-radius: 20px; background: #0057e7; color: #fff; cursor: pointer; }
button:hover { background: #0041b0; }
#file-input { display: none; }
.status { font-size: 0.8em; color: #666; margin-left: 10px; }
</style>
</head>
<body>

<div class="toolbar">
<button onclick="document.getElementById('file-input').click()">üìé Archivo</button>
<input type="file" id="file-input" onchange="handleFile(this.files[0])" />
<label><input type="checkbox" id="web-search" /> üîç B√∫squeda web</label>
<label><input type="checkbox" id="deep-think" /> üß† Razonamiento profundo</label>
<button onclick="clearHistory()">üóëÔ∏è Borrar historial</button>
<span class="status" id="status"></span>
</div>

<div id="chat-box"></div>

<div id="input-area">
<input type="text" id="user-input" placeholder="Escribe tu mensaje o usa las funciones avanzadas..." onkeypress="if(event.key==='Enter') sendMessage()" />
<button onclick="sendMessage()">Enviar</button>
</div>

<script src="https://js.puter.com/v2/"></script>
<script>
const chatBox = document.getElementById('chat-box');
const input = document.getElementById('user-input');
const status = document.getElementById('status');
let currentFile = null;

function loadHistory() {
const history = JSON.parse(localStorage.getItem('kimi-pro-history') || '[]');
history.forEach(msg => appendMessage(msg.role, msg.text, msg.file));
}

function saveMessage(role, text, file = null) {
const history = JSON.parse(localStorage.getItem('kimi-pro-history') || '[]');
history.push({ role, text, file });
localStorage.setItem('kimi-pro-history', JSON.stringify(history));
}

function appendMessage(role, text, file = null) {
const msgDiv = document.createElement('div');
msgDiv.className = 'msg ' + role;

const bubble = document.createElement('div');
bubble.className = 'bubble';
bubble.textContent = text;

if (file && role === 'user') {
const fileInfo = document.createElement('div');
fileInfo.className = 'file-info';
fileInfo.textContent = `üìÑ Archivo: ${file.name} (${file.type})`;
msgDiv.appendChild(fileInfo);
}

msgDiv.appendChild(bubble);
chatBox.appendChild(msgDiv);
chatBox.scrollTop = chatBox.scrollHeight;
}

async function handleFile(file) {
if (!file) return;
currentFile = file;
status.textContent = `Archivo listo: ${file.name}`;
setTimeout(() => status.textContent = '', 3000);
}

async function sendMessage() {
const text = input.value.trim();
if (!text && !currentFile) return;

const useWebSearch = document.getElementById('web-search').checked;
const deepThink = document.getElementById('deep-think').checked;

appendMessage('user', text, currentFile);
saveMessage('user', text, currentFile);
input.value = '';

try {
status.textContent = 'ü§î Kimi est√° pensando...';

const options = {
model: 'moonshotai/kimi-k2',
stream: false,
context: `Web search: ${useWebSearch}, Deep thinking: ${deepThink}`
};

let response;
if (currentFile) {
const reader = new FileReader();
reader.onload = async (e) => {
options.file = { name: currentFile.name, content: e.target.result };
response = await puter.ai.chat(text || 'Analiza este archivo', options);
handleResponse(response, text);
};
reader.readAsText(currentFile);
return;
} else {
response = await puter.ai.chat(text, options);
handleResponse(response, text);
}
} catch (err) {
appendMessage('bot', '‚ùå Error: ' + err.message);
saveMessage('bot', 'Error');
status.textContent = '';
}
}

function handleResponse(response, originalText) {
appendMessage('bot', response);
saveMessage('bot', response);
status.textContent = '';
currentFile = null;
}

function clearHistory() {
if(confirm('¬øBorrar todo el historial?')) {
localStorage.removeItem('kimi-pro-history');
chatBox.innerHTML = '';
status.textContent = '‚úÖ Historial borrado';
setTimeout(() => status.textContent = '', 2000);
}
}

window.onload = loadHistory;
</script>
</body>
</html>
